<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ page.title }} | {{ site.title }}</title>
    {% if site.description %}
    <meta name="description" content="{{ site.description }}" />
    {% endif %}
    <style>
      :root {
        --bg: #0b0e11;
        --fg: #e6e6e6;
        --muted: rgba(255,255,255,.65);
        --nav-bg: #111519;
        --accent: #00ff9c;
        --border: rgba(255,255,255,.08);
      }

      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: "Courier New", Courier, monospace;
        background: var(--bg);
        color: var(--fg);
        line-height: 1.6;
      }

      a { color: inherit; }

      .topbar {
        background: var(--nav-bg);
        border-bottom: 1px solid var(--border);
      }

      .topbar-inner {
        max-width: 1100px;
        margin: 0 auto;
        padding: 16px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
      }

      .brand {
        font-size: 1.4rem;
        font-weight: 700;
        letter-spacing: .5px;
        text-decoration: none;
      }

      .nav {
        display: flex;
        gap: 18px;
        flex-wrap: wrap;
        font-weight: 600;
      }

      .nav a {
        text-decoration: none;
        color: var(--muted);
        padding: 6px 8px;
        border-radius: 8px;
        transition: color .15s ease, background .15s ease;
      }

      .nav a:hover {
        color: var(--fg);
        background: rgba(255,255,255,.06);
      }

      .nav a.active {
        color: var(--accent);
      }

      .wrap {
        max-width: 1100px;
        margin: 0 auto;
        padding: 24px 20px 60px;
      }

      .post-layout {
        display: grid;
        grid-template-columns: 180px minmax(0, 1fr);
        gap: 28px;
        align-items: start;
      }

      .post-toc {
        position: sticky;
        top: 20px;
        align-self: start;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px 10px;
        background: rgba(255,255,255,.02);
        text-align: left;
      }

      .toc-title {
        font-weight: 700;
        margin-bottom: 8px;
        font-size: 0.95rem;
        letter-spacing: .3px;
      }

      .toc-links {
        display: flex;
        flex-direction: column;
        gap: 8px;
        font-size: 0.92rem;
      }

      .toc-links a {
        text-decoration: none;
        color: var(--muted);
        padding: 4px 6px;
        border-radius: 6px;
      }

      .toc-links a:hover {
        color: var(--fg);
        background: rgba(255,255,255,.06);
      }

      .toc-links a.active {
        color: var(--accent);
      }

      .post-section {
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px 16px 8px;
        margin: 18px 0 22px;
        background: rgba(255,255,255,.02);
      }

      .post-section video,
      .post-section iframe {
        display: block;
        width: 100%;
        max-width: 900px;
        margin: 14px auto 6px;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: rgba(255,255,255,.02);
      }

      .post-section > :first-child {
        margin-top: 0;
      }

      @media (max-width: 900px) {
        .post-layout {
          grid-template-columns: 1fr;
        }
        .post-toc {
          position: static;
        }
      }

      @media (min-width: 1200px) {
        .post-toc {
          margin-left: calc((100vw - 1100px) / -2);
        }
      }

      .glossary-term {
        position: relative;
        border-bottom: 1px dotted rgba(0, 255, 156, 0.7);
        cursor: help;
      }

      .glossary-term::after {
        content: attr(data-tip);
        position: absolute;
        left: 0;
        bottom: 125%;
        min-width: 220px;
        max-width: 340px;
        background: #0f1418;
        color: var(--fg);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 10px 12px;
        font-family: inherit;
        font-size: 1rem;
        line-height: 1.4;
        box-shadow: 0 10px 30px rgba(0,0,0,.35);
        opacity: 0;
        pointer-events: none;
        transform: translateY(6px);
        transition: opacity .15s ease, transform .15s ease;
        z-index: 20;
      }

      .glossary-term:hover::after {
        opacity: 1;
        transform: translateY(0);
      }

      @media (max-width: 640px) {
        .topbar-inner {
          flex-direction: column;
          align-items: flex-start;
        }
      }
    </style>
  </head>
  <body>
    <header class="topbar">
      <div class="topbar-inner">
        <a class="brand" href="{{ '/' | relative_url }}">{{ site.title }}</a>
        <nav class="nav">
          <a href="{{ '/' | relative_url }}" class="{% if page.url == '/' %}active{% endif %}">Home</a>
          <a href="{{ '/about/' | relative_url }}" class="{% if page.url contains '/about' %}active{% endif %}">About</a>
          <a href="{{ '/termlista/' | relative_url }}" class="{% if page.url contains '/termlista' %}active{% endif %}">Termlista</a>
        </nav>
      </div>
    </header>
    <main class="wrap">
      {{ content }}
    </main>
    <meta name="glossary-link" content="enabled" />
    <script>
      (function () {
        var post = document.querySelector(".post");
        if (!post) return;

        var glossary = [
          { term: "FakeCaptcha", def: "En phishingmetod som lurar användaren att själv köra skadlig kod via falsk CAPTCHA.", pattern: "\\bFakeCaptcha\\b", slug: "fakecaptcha" },
          { term: "phishing", def: "Angrepp där angripare lurar användare att göra något farligt eller lämna ut info.", pattern: "\\bphishing\\b", slug: "phishing" },
          { term: "CAPTCHA", def: "Test som ska skilja människor från botar, ofta missbrukat i bluffar.", pattern: "\\bCAPTCHA\\b", slug: "captcha-recaptcha" },
          { term: "reCAPTCHA", def: "Test som ska skilja människor från botar, ofta missbrukat i bluffar.", pattern: "\\breCAPTCHA\\b", slug: "captcha-recaptcha" },
          { term: "PowerShell", def: "Windows-kommandoskal och skriptspråk som ofta utnyttjas i attacker.", pattern: "\\bPowerShell\\b", slug: "powershell" },
          { term: "mshta.exe", def: "Windows-program som kan köra HTML/skript och används ibland som \"living-off-the-land\".", pattern: "mshta\\.exe", slug: "mshta-exe" },
          { term: "Win+R", def: "Windows‑dialog för att köra kommandon snabbt.", pattern: "Win\\+R", slug: "run-win-r" },
          { term: "Run", def: "Windows‑dialog för att köra kommandon snabbt.", pattern: "\\bRun\\b", slug: "run-win-r" },
          { term: "clipboard", def: "Temporärt minne för kopierad text, som kan fyllas med skadliga kommandon.", pattern: "\\bclipboard\\b", slug: "clipboard-urklipp" },
          { term: "Malvertising", def: "Skadlig annonsering som leder till bluff- eller malware-sidor.", pattern: "\\bmalvertising\\b", slug: "malvertising" },
          { term: "SEO-poisoning", def: "Manipulation av sökresultat för att få skadliga sidor att ranka högt.", pattern: "SEO-?poisoning", slug: "seo-poisoning" },
          { term: "redirects", def: "Omdirigeringar som skickar dig vidare till en annan, ofta skadlig, sida.", pattern: "\\bredirects\\b", slug: "redirects" },
          { term: "EDR", def: "Endpoint Detection and Response, verktyg som upptäcker och stoppar attacker på klienter.", pattern: "\\bEDR\\b", slug: "edr" },
          { term: "LOLBins", def: "\"Living-off-the-land\"‑verktyg i OS som missbrukas av angripare.", pattern: "\\bLOLBins\\b", slug: "lolbins" },
          { term: "-EncodedCommand", def: "PowerShell‑flagga för att köra kod i kodad form, vanligt i attacker.", pattern: "-EncodedCommand", slug: "encodedcommand" },
          { term: "-WindowStyle Hidden", def: "PowerShell‑flagga som kör kommandon dolt utan fönster.", pattern: "-WindowStyle\\s+Hidden", slug: "windowstyle-hidden" },
          { term: "MFA", def: "Multifaktorautentisering, extra steg ut över lösenord.", pattern: "\\bMFA\\b", slug: "mfa" },
          { term: "Punycode", def: "Tekniker som gör falska domäner svåra att skilja från riktiga.", pattern: "\\bPunycode\\b", slug: "punycode-idn-homoglyfer" },
          { term: "IDN", def: "Tekniker som gör falska domäner svåra att skilja från riktiga.", pattern: "\\bIDN\\b", slug: "punycode-idn-homoglyfer" },
          { term: "stealer", def: "Malware som stjäl inloggningar, cookies eller annan data.", pattern: "\\bstealer(s)?\\b", slug: "stealer" },
          { term: "RAT", def: "Remote Access Trojan, ger angriparen fjärrkontroll över datorn.", pattern: "\\bRAT\\b", slug: "rat" },
          { term: "malware", def: "Skadlig kod som infekterar system.", pattern: "\\bmalware\\b", slug: "malware" },
          { term: "crypto mining", def: "Missbruk av din dator för att utvinna kryptovaluta.", pattern: "crypto\\s+mining", slug: "crypto-mining" }
        ];

        var patterns = glossary.map(function (g) { return g.pattern; });
        var re = new RegExp("(" + patterns.join("|") + ")", "gi");
        var byTerm = {};
        glossary.forEach(function (g) {
          byTerm[g.term.toLowerCase()] = g;
        });

        function slugifyTerm(s) {
          return s
            .toLowerCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .replace(/[^a-z0-9]+/g, "-")
            .replace(/^-+|-+$/g, "");
        }

        function wrapNode(textNode) {
          var text = textNode.nodeValue;
          if (!re.test(text)) return;
          re.lastIndex = 0;

          var frag = document.createDocumentFragment();
          var last = 0;
          var m;
          while ((m = re.exec(text)) !== null) {
            var match = m[0];
            var start = m.index;
            var end = start + match.length;
            if (start > last) {
              frag.appendChild(document.createTextNode(text.slice(last, start)));
            }

            var key = match.toLowerCase();
            var entry = byTerm[key];
            if (!entry) {
              for (var i = 0; i < glossary.length; i++) {
                var testRe = new RegExp("^" + glossary[i].pattern + "$", "i");
                if (testRe.test(match)) { entry = glossary[i]; break; }
              }
            }

            if (entry) {
              var link = document.createElement("a");
              link.className = "glossary-term";
              link.setAttribute("data-tip", entry.def);
              link.href = "{{ '/termlista/' | relative_url }}#term-" + entry.slug;
              link.textContent = match;
              frag.appendChild(link);
            } else {
              frag.appendChild(document.createTextNode(match));
            }

            last = end;
          }
          if (last < text.length) {
            frag.appendChild(document.createTextNode(text.slice(last)));
          }
          textNode.parentNode.replaceChild(frag, textNode);
        }

        var allowedHeadings = [
          "Fakecaptcha",
          "FakeError",
          "Initial Access",
          "Stoppa FakeCaptcha innan det händer",
          "Är domänen legitim? Snabb koll",
          "Tricks hackarna har använt sig av",
          "Konsekvenserna",
          "Laboration demo",
          "Referenser"
        ];

        var headings = Array.prototype.slice.call(post.querySelectorAll("h2"));
        headings = headings.filter(function (h) {
          return allowedHeadings.indexOf(h.textContent.trim()) !== -1;
        });
        var toc = document.querySelector(".toc-links");
        if (toc && headings.length) {
          headings.forEach(function (h, idx) {
            if (!h.id) h.id = "section-" + (idx + 1);
            var a = document.createElement("a");
            a.href = "#" + h.id;
            a.textContent = h.textContent;
            a.dataset.target = h.id;
            toc.appendChild(a);
          });
        }

        function wrapSections() {
          if (!headings.length) return;
          headings.forEach(function (h) {
            var section = document.createElement("section");
            section.className = "post-section";
            h.parentNode.insertBefore(section, h);
            section.appendChild(h);
            var next = h.nextSibling;
            while (next && !(next.nodeType === 1 && /H2/.test(next.nodeName))) {
              var move = next;
              next = next.nextSibling;
              section.appendChild(move);
            }
          });
        }

        wrapSections();

        if (toc && headings.length) {
          var tocLinks = toc.querySelectorAll("a");
          var observer = new IntersectionObserver(function (entries) {
            entries.forEach(function (entry) {
              if (!entry.isIntersecting) return;
              var id = entry.target.id;
              tocLinks.forEach(function (l) {
                l.classList.toggle("active", l.dataset.target === id);
              });
            });
          }, { rootMargin: "-30% 0px -60% 0px", threshold: 0.1 });
          headings.forEach(function (h) { observer.observe(h); });
        }

        var walker = document.createTreeWalker(
          post,
          NodeFilter.SHOW_TEXT,
          {
            acceptNode: function (node) {
              if (!node.nodeValue || !node.nodeValue.trim()) return NodeFilter.FILTER_REJECT;
              var parent = node.parentNode;
              if (!parent) return NodeFilter.FILTER_REJECT;
              var tag = parent.nodeName;
              if (/(SCRIPT|STYLE|CODE|PRE|A|TEXTAREA|KBD|H1|H2|H3|H4|H5|H6)/.test(tag)) return NodeFilter.FILTER_REJECT;
              return NodeFilter.FILTER_ACCEPT;
            }
          }
        );

        var nodes = [];
        while (walker.nextNode()) nodes.push(walker.currentNode);
        nodes.forEach(wrapNode);
      })();
    </script>
  </body>
</html>
